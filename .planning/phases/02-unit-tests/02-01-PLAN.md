---
phase: 02-unit-tests
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - __tests__/gachaReducer.test.ts
  - __tests__/gacha.test.tsx
autonomous: true
user_setup: []

must_haves:
  truths:
    - "gachaReducer의 모든 액션이 테스트로 검증된다"
    - "가챠 확률 계산이 천장 시스템을 포함하여 검증된다"
    - "npm test 실행 시 모든 가챠 관련 테스트가 통과한다"
  artifacts:
    - path: "__tests__/gachaReducer.test.ts"
      provides: "gachaReducer 액션별 단위 테스트"
      exports: ["describe('gachaReducer')"]
    - path: "__tests__/gacha.test.tsx"
      provides: "확장된 가챠 확률 테스트"
      contains: "doSinglePull"
  key_links:
    - from: "__tests__/gachaReducer.test.ts"
      to: "lib/reducers/gachaReducer.ts"
      via: "import gachaReducer"
      pattern: "import.*gachaReducer"
    - from: "__tests__/gacha.test.tsx"
      to: "lib/gacha/gachaLogic.ts"
      via: "import gacha functions"
      pattern: "import.*doSinglePull"
---

<objective>
가챠 관련 비즈니스 로직의 단위 테스트 작성

Purpose: 가챠 시뮬레이터의 핵심인 확률 계산과 상태 관리가 정확하게 동작함을 검증한다
Output: gachaReducer.test.ts (신규), gacha.test.tsx (확장)
</objective>

<execution_context>
@/Users/lyvakim/.claude/get-shit-done/workflows/execute-plan.md
@/Users/lyvakim/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-infrastructure/01-01-SUMMARY.md

# Source files to test
@lib/reducers/gachaReducer.ts
@lib/gacha/gachaLogic.ts
@__tests__/gacha.test.tsx
@__tests__/fixtures/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: gachaReducer 단위 테스트 작성</name>
  <files>__tests__/gachaReducer.test.ts</files>
  <action>
lib/reducers/gachaReducer.ts의 모든 액션에 대한 단위 테스트를 작성한다.

테스트 케이스:
1. GACHA_PULL 액션
   - results, totalPulls, rarityStats, pityCount, pickupGuarantee가 올바르게 업데이트되는지
   - totalPulls가 누적되는지 (state.totalPulls + action.payload.times)

2. ADD_SIX_STAR_HISTORY 액션
   - sixStarHistory 배열 앞에 새 항목이 추가되는지
   - 기존 항목들이 유지되는지

3. RESET_ALL 액션
   - initialGachaState로 완전히 초기화되는지

4. TOGGLE_LEFT_SIDEBAR / TOGGLE_RIGHT_SIDEBAR 액션
   - boolean 토글이 올바르게 동작하는지

5. SET_FIRST_PULL 액션
   - isFirstPull이 payload 값으로 설정되는지

6. UPDATE_PICKUP_INFO 액션
   - pickupShape, pickupRank가 올바르게 업데이트되는지
   - null 값도 올바르게 처리되는지

7. 알 수 없는 액션
   - 기존 state를 그대로 반환하는지

패턴:
- AAA (Arrange-Act-Assert) 패턴 사용
- 한국어 테스트 설명 (기존 패턴 유지)
- mock Character 객체는 __tests__/fixtures에서 import
  </action>
  <verify>npm test -- --testPathPattern=gachaReducer.test.ts --verbose</verify>
  <done>gachaReducer의 7개 액션 타입 모두 테스트 통과</done>
</task>

<task type="auto">
  <name>Task 2: 가챠 확률 계산 테스트 확장</name>
  <files>__tests__/gacha.test.tsx</files>
  <action>
기존 gacha.test.tsx를 확장하여 doSinglePull, doSinglePullDoublePick 함수의 상세 테스트를 추가한다.

추가할 테스트 케이스:

1. doSinglePull (일반 픽업 배너)
   - 70연차 천장 도달 시 무조건 6성 반환
   - pickupGuarantee=true일 때 픽업 캐릭터 확정
   - 6성 뽑으면 pity 0으로 리셋
   - 비6성 뽑으면 pity 증가

2. doSinglePullDoublePick (2중 픽업 배너)
   - 70연차 천장 시 6성 확정
   - pickupGuarantee=true일 때 2명 중 1명 확정
   - 70% 확률로 픽업 캐릭터 중 1명 (통계적 테스트: 1000회 시뮬레이션)

3. calculateGachaPull 통합
   - 배너 타입에 따라 올바른 함수가 호출되는지 (bannerType: "doublePick" vs 일반)
   - 연속 뽑기에서 pity가 올바르게 누적되는지

4. isValidGachaCharacterForPool
   - exclude_gacha=true인 캐릭터 제외
   - immediate_standard=true인 캐릭터 포함
   - 버전 기반 필터링 동작

mock 데이터:
- __tests__/fixtures에서 mockCharacters, mockBanners 사용
- Math.random 모킹으로 확률 테스트 결정론적 수행

주의:
- 기존 테스트는 유지하고 새 describe 블록으로 추가
- 통계적 테스트는 허용 오차 범위 설정 (예: 70% +/- 5%)
  </action>
  <verify>npm test -- --testPathPattern=gacha.test.tsx --verbose</verify>
  <done>doSinglePull, doSinglePullDoublePick, isValidGachaCharacterForPool 테스트 포함하여 전체 15개+ 테스트 통과</done>
</task>

</tasks>

<verification>
```bash
# 모든 가챠 관련 테스트 실행
npm test -- --testPathPattern="gacha" --verbose

# 테스트 커버리지 확인 (gacha 관련 파일)
npm test -- --coverage --collectCoverageFrom="lib/gacha/**/*.ts" --collectCoverageFrom="lib/reducers/gachaReducer.ts"
```
</verification>

<success_criteria>
- [ ] gachaReducer.test.ts가 생성되어 모든 액션 테스트 통과
- [ ] gacha.test.tsx에 doSinglePull, doSinglePullDoublePick 테스트 추가
- [ ] isValidGachaCharacterForPool 테스트 추가
- [ ] npm test 실행 시 모든 테스트 통과 (0 failures)
- [ ] UNIT-01, UNIT-02 요구사항 충족
</success_criteria>

<output>
After completion, create `.planning/phases/02-unit-tests/02-01-SUMMARY.md`
</output>
