---
phase: 02-unit-tests
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - __tests__/quizTypes.test.ts
  - __tests__/storage.test.ts
  - __tests__/cdn.test.ts
  - __tests__/version.test.ts
  - __tests__/farmingHelper.test.ts
  - __tests__/characterFilter.test.ts
autonomous: true
user_setup: []

must_haves:
  truths:
    - "퀴즈 타입 가드가 올바른 타입을 구분한다"
    - "storage 유틸리티가 localStorage를 올바르게 다룬다"
    - "CDN URL 생성이 환경에 따라 올바르게 동작한다"
    - "버전 비교 로직이 정확하게 동작한다"
    - "파밍 헬퍼가 재료 계산을 올바르게 수행한다"
    - "캐릭터 필터링이 검색어와 속성에 따라 동작한다"
  artifacts:
    - path: "__tests__/quizTypes.test.ts"
      provides: "퀴즈 타입 가드 테스트"
      exports: ["describe('Quiz Type Guards')"]
    - path: "__tests__/storage.test.ts"
      provides: "storage 유틸리티 테스트"
      exports: ["describe('storage')"]
    - path: "__tests__/cdn.test.ts"
      provides: "CDN URL 생성 테스트"
      exports: ["describe('getCdnUrl')"]
    - path: "__tests__/version.test.ts"
      provides: "버전 비교 로직 테스트"
      exports: ["describe('version')"]
    - path: "__tests__/farmingHelper.test.ts"
      provides: "파밍 헬퍼 테스트"
      exports: ["describe('farmingHelper')"]
    - path: "__tests__/characterFilter.test.ts"
      provides: "캐릭터 필터 로직 테스트"
      exports: ["describe('characterFilter')"]
  key_links:
    - from: "__tests__/storage.test.ts"
      to: "lib/storage.ts"
      via: "import storage"
      pattern: "import.*storage"
    - from: "__tests__/version.test.ts"
      to: "data/version.ts"
      via: "import version functions"
      pattern: "import.*compareVersions"
---

<objective>
유틸리티 함수 및 기타 비즈니스 로직의 단위 테스트 작성

Purpose: 퀴즈 타입 가드, storage, CDN, 버전 비교, 파밍 헬퍼, 캐릭터 필터 로직이 정확하게 동작함을 검증한다
Output: 6개의 새 테스트 파일
</objective>

<execution_context>
@/Users/lyvakim/.claude/get-shit-done/workflows/execute-plan.md
@/Users/lyvakim/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-infrastructure/01-01-SUMMARY.md

# Source files to test
@lib/types/quizTypes.ts
@lib/storage.ts
@lib/cdn.ts
@data/version.ts
@lib/utils/farmingHelper.ts
@components/character/Character.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: 퀴즈 타입 가드 및 버전/CDN 테스트 작성</name>
  <files>__tests__/quizTypes.test.ts, __tests__/version.test.ts, __tests__/cdn.test.ts</files>
  <action>
순수 함수 기반의 유틸리티 테스트를 작성한다.

**quizTypes.test.ts:**
lib/types/quizTypes.ts의 타입 가드 함수 테스트

1. isMultipleChoiceQuestion
   - type: "multiple_choice" -> true
   - 다른 타입 -> false

2. isImageTextInputQuestion
   - type: "image_text_input" -> true
   - 다른 타입 -> false

3. isTextInputQuestion
   - type: "text_input" -> true
   - 다른 타입 -> false

4. isTrueFalseQuestion
   - type: "true_false" -> true
   - 다른 타입 -> false

**version.test.ts:**
data/version.ts의 버전 관련 함수 테스트

1. compareVersions
   - "1.0" vs "2.0" -> 음수 (1.0이 작음)
   - "2.0" vs "1.0" -> 양수 (2.0이 큼)
   - "2.5" vs "2.5" -> 0 (같음)
   - "2.1" vs "2.10" -> 음수 (2.1 < 2.10)
   - Edge case: "2.75" (소수점 두 자리)

2. isOlderVersion / isNewerVersion
   - 현재 버전(3.2) 기준으로 테스트

3. isCollabVersion
   - "2.75" -> true
   - "2.0" -> false

4. getDisplayVersion
   - "2.75" -> "콜라보"
   - "2.0" -> "2.0"

5. isIncludedInGachaPool
   - 3버전 이전 캐릭터 -> true
   - 최신 버전 캐릭터 -> false
   - immediate_standard=true -> true

**cdn.test.ts:**
lib/cdn.ts의 CDN URL 생성 함수 테스트

1. getCdnUrl
   - CDN_URL 없을 때: "/path/to/file" 형태
   - CDN_URL 있을 때: "https://cdn.example.com/path/to/file" 형태
   - 앞의 슬래시 정규화 (//path -> /path)
   - 뒤의 슬래시 정규화 (CDN_URL 끝 슬래시 제거)

2. getSkinIllustUrl, getSkinListUrl, getBannerUrl
   - 올바른 경로 조합 확인

3. getCharacterUrl
   - isSmall=true일 때 "_small" 접미사 추가
   - 항상 로컬 경로 반환 (CDN 미사용)

환경 변수 모킹:
- process.env.NEXT_PUBLIC_CDN_URL을 jest.mock으로 제어
  </action>
  <verify>npm test -- --testPathPattern="quizTypes|version|cdn" --verbose</verify>
  <done>quizTypes.test.ts, version.test.ts, cdn.test.ts 생성 및 전체 테스트 통과</done>
</task>

<task type="auto">
  <name>Task 2: storage 유틸리티 테스트 작성</name>
  <files>__tests__/storage.test.ts</files>
  <action>
lib/storage.ts의 localStorage 래퍼 함수 테스트를 작성한다.

테스트 케이스:

1. storage.get
   - 존재하는 키: 저장된 값 반환
   - 존재하지 않는 키: null 반환
   - JSON 파싱: 객체/배열 저장된 경우 파싱된 값 반환
   - 단순 문자열: 그대로 반환
   - SSR 환경 (window undefined): null 반환
   - localStorage 에러 발생 시: null 반환 (console.error 호출)

2. storage.set
   - 문자열 값: 그대로 저장
   - 객체/배열 값: JSON.stringify하여 저장
   - SSR 환경: 아무 동작 안 함
   - localStorage 에러: 무시 (console.error 호출)

3. storage.remove
   - 키 삭제 확인
   - SSR 환경: 아무 동작 안 함

4. storage.clear
   - 전체 삭제 확인
   - SSR 환경: 아무 동작 안 함

5. storage.has
   - 존재하는 키: true
   - 존재하지 않는 키: false

localStorage 모킹:
- jest.spyOn(Storage.prototype, 'getItem')
- jest.spyOn(Storage.prototype, 'setItem')
- jest.spyOn(Storage.prototype, 'removeItem')
- jest.spyOn(Storage.prototype, 'clear')

SSR 환경 테스트:
- window를 undefined로 설정하는 방법 사용
  </action>
  <verify>npm test -- --testPathPattern=storage.test.ts --verbose</verify>
  <done>storage의 get, set, remove, clear, has 함수 테스트 통과</done>
</task>

<task type="auto">
  <name>Task 3: 파밍 헬퍼 및 캐릭터 필터 테스트 작성</name>
  <files>__tests__/farmingHelper.test.ts, __tests__/characterFilter.test.ts</files>
  <action>
복잡한 비즈니스 로직의 테스트를 작성한다.

**farmingHelper.test.ts:**
lib/utils/farmingHelper.ts의 재료 계산 로직 테스트

1. expandCraftingRequirements
   - 빈 배열 입력 -> 빈 배열 반환
   - 조합 불필요한 재료(3성 이하) -> 그대로 반환
   - 조합 필요한 재료(4성 이상) -> 하위 재료로 펼침
   - 보유량이 충분한 재료 -> 조합 안 함
   - 일부만 조합 가능한 경우 -> 부분 펼침

2. groupDeficitsByStage (기본 동작만)
   - 빈 배열 -> { highPriority: [], lowPriority: [] }
   - 부족한 재료 없음 -> 빈 결과

모킹:
- getCraftingRecipe, getStagesForMaterial 함수 모킹
- materialList 일부 모킹

**characterFilter.test.ts:**
components/character/Character.tsx의 필터 로직을 추출하여 테스트

필터 로직 추출 (별도 함수로):
```typescript
// lib/utils/characterFilter.ts (필요시 생성)
export function filterCharacters(
  characters: Character[],
  searchQuery: string,
  selectedAttr: string
): Character[] {
  return characters.filter((ch) => {
    const matchesSearch =
      ch.name.includes(searchQuery) ||
      ch.engName.toLowerCase().includes(searchQuery.toLowerCase());
    const matchesAttr = selectedAttr === "all" || ch.inspiration === selectedAttr;
    return matchesSearch && matchesAttr;
  });
}
```

테스트 케이스:
1. 이름 검색 (한국어)
   - "드루비스" 검색 -> 드루비스 포함 결과
   - 부분 일치: "드루" 검색 -> 드루비스 포함

2. 이름 검색 (영어, 대소문자 무시)
   - "druvis" 검색 -> druvis-iii 포함
   - "DRUVIS" 검색 -> druvis-iii 포함

3. 속성 필터
   - "all" -> 전체 캐릭터
   - "plant" -> plant 영감 캐릭터만

4. 복합 필터
   - 검색어 + 속성 동시 적용

캐릭터 필터 함수가 컴포넌트 내부에 있으므로:
1. 먼저 lib/utils/characterFilter.ts로 추출
2. 그 후 테스트 작성
  </action>
  <verify>npm test -- --testPathPattern="farmingHelper|characterFilter" --verbose</verify>
  <done>farmingHelper.test.ts, characterFilter.test.ts 생성 및 테스트 통과</done>
</task>

</tasks>

<verification>
```bash
# 모든 유틸리티 테스트 실행
npm test -- --testPathPattern="quizTypes|storage|cdn|version|farmingHelper|characterFilter" --verbose

# 전체 유닛 테스트
npm test -- --verbose
```
</verification>

<success_criteria>
- [ ] quizTypes.test.ts - 4개 타입 가드 함수 테스트 통과
- [ ] storage.test.ts - get, set, remove, clear, has 테스트 통과
- [ ] cdn.test.ts - getCdnUrl 및 헬퍼 함수 테스트 통과
- [ ] version.test.ts - compareVersions, isOlderVersion 등 테스트 통과
- [ ] farmingHelper.test.ts - expandCraftingRequirements 기본 테스트 통과
- [ ] characterFilter.test.ts - 필터 로직 테스트 통과 (함수 추출 포함)
- [ ] npm run test:unit 실행 시 모든 테스트 통과
- [ ] UNIT-03, UNIT-04, UNIT-05, UNIT-06, UNIT-07, UNIT-08 요구사항 충족
</success_criteria>

<output>
After completion, create `.planning/phases/02-unit-tests/02-02-SUMMARY.md`
</output>
