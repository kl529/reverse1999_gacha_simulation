---
phase: 01-infrastructure
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - lib/gacha/gachaLogic.ts
  - components/gacha_simulator/GachaGame.tsx
  - __tests__/gacha.test.tsx
  - playwright.config.ts
  - __tests__/fixtures/mockBanners.ts
  - __tests__/fixtures/mockCharacters.ts
  - __tests__/fixtures/index.ts
  - package.json
autonomous: true

must_haves:
  truths:
    - "npm test 실행 시 gacha.test.tsx가 오류 없이 통과한다"
    - "npm run test:e2e 실행 시 Playwright가 정상 동작한다"
    - "테스트 파일에서 fixtures를 import하여 mock 데이터를 사용할 수 있다"
    - "npm run test:ci 실행 시 모든 테스트가 순차적으로 실행된다"
  artifacts:
    - path: "lib/gacha/gachaLogic.ts"
      provides: "추출된 가챠 확률 계산 로직"
      exports: ["getSixStarRate", "calculateGachaPull"]
    - path: "playwright.config.ts"
      provides: "Playwright E2E 테스트 설정"
      contains: "defineConfig"
    - path: "__tests__/fixtures/index.ts"
      provides: "Mock 데이터 중앙 export"
      exports: ["mockBanners", "mockCharacters"]
  key_links:
    - from: "__tests__/gacha.test.tsx"
      to: "lib/gacha/gachaLogic.ts"
      via: "import 문"
      pattern: "import.*from.*lib/gacha/gachaLogic"
    - from: "package.json"
      to: "playwright.config.ts"
      via: "test:e2e 스크립트"
      pattern: "playwright test"
---

<objective>
테스트 인프라를 완전히 구축하여 모든 테스트 레벨(Unit, Component, E2E)을 실행할 수 있는 기반을 마련한다.

Purpose: 현재 깨진 테스트를 수정하고, 향후 Phase 2-4에서 작성할 테스트들이 실행될 수 있는 환경을 구축한다.
Output: 동작하는 Jest 테스트, Playwright E2E 설정, 테스트용 fixtures, CI 스크립트
</objective>

<execution_context>
@/Users/lyvakim/.claude/get-shit-done/workflows/execute-plan.md
@/Users/lyvakim/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# 현재 깨진 테스트 파일
@__tests__/gacha.test.tsx

# 가챠 로직이 있는 컴포넌트 (handleGacha 함수 포함)
@components/gacha_simulator/GachaGame.tsx

# 기존 Jest 설정
@jest.config.js
@jest.setup.js

# 기존 리듀서 (상태 관리)
@lib/reducers/gachaReducer.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: 가챠 로직 추출 및 테스트 수정</name>
  <files>
    lib/gacha/gachaLogic.ts
    components/gacha_simulator/GachaGame.tsx
    __tests__/gacha.test.tsx
  </files>
  <action>
1. `lib/gacha/gachaLogic.ts` 파일 생성:
   - GachaGame.tsx에서 확률 계산 로직 추출
   - `getSixStarRate(pity: number): number` 함수 export (pity < 60이면 1.5%, 이후 증가)
   - `calculateGachaPull` 함수 생성: 배너와 상태를 받아 캐릭터 배열 반환
   - 순수 함수로 구현하여 React 상태 의존성 제거

2. `components/gacha_simulator/GachaGame.tsx` 수정:
   - 추출한 로직을 import하여 사용
   - 기존 handleGacha 내부에서 새 함수 호출

3. `__tests__/gacha.test.tsx` 수정:
   - import 경로를 `@/lib/gacha/gachaLogic`로 변경
   - calculateGachaPull 함수를 사용하여 테스트
   - 기존 테스트 케이스(70연차 내 6성 1개 이상) 유지

주의: GachaGame.tsx의 기존 동작을 변경하지 않도록 한다. 로직만 추출하고 기존 호출 구조 유지.
  </action>
  <verify>
npm test -- --testPathPattern=gacha.test.tsx

실행 결과: PASS가 출력되고 "70연차 내에 최소 1번은 6성 캐릭터가 나와야 한다" 테스트 통과
  </verify>
  <done>
gacha.test.tsx가 오류 없이 통과하고, 추출된 gachaLogic.ts가 GachaGame.tsx에서 정상적으로 사용된다.
  </done>
</task>

<task type="auto">
  <name>Task 2: Playwright 설정 및 테스트 fixtures 구성</name>
  <files>
    playwright.config.ts
    __tests__/fixtures/mockBanners.ts
    __tests__/fixtures/mockCharacters.ts
    __tests__/fixtures/index.ts
    package.json
  </files>
  <action>
1. Playwright 설치:
   ```bash
   npm install -D @playwright/test
   npx playwright install chromium
   ```

2. `playwright.config.ts` 생성:
   - baseURL: 'http://localhost:3000'
   - testDir: '__tests__/e2e'
   - webServer 설정 (npm run dev 자동 실행)
   - timeout: 30000
   - chromium만 사용 (빠른 실행을 위해)

3. `__tests__/fixtures/mockBanners.ts` 생성:
   - 테스트용 배너 데이터 (최소 2개: 일반 픽업, 2중 픽업)
   - Banner 타입 준수

4. `__tests__/fixtures/mockCharacters.ts` 생성:
   - 테스트용 캐릭터 데이터 (각 레어도별 최소 2개)
   - Character 타입 준수

5. `__tests__/fixtures/index.ts` 생성:
   - mockBanners, mockCharacters 재export

6. `package.json` 스크립트 추가:
   - "test:e2e": "playwright test"
   - "test:ci": "npm run test && npm run test:e2e"
   - "test": "jest" (기존 없으면 추가)

주의: 기존 package.json 스크립트를 덮어쓰지 않도록 한다.
  </action>
  <verify>
npm run test:e2e -- --help

실행 결과: Playwright CLI 도움말이 출력된다 (테스트 파일 없음 경고는 무시)

추가 확인:
- node -e "require('./__tests__/fixtures')"
- 에러 없이 실행되면 fixtures 구조 정상
  </verify>
  <done>
- Playwright가 설치되고 playwright.config.ts가 존재한다
- __tests__/fixtures/ 디렉토리에 mockBanners.ts, mockCharacters.ts, index.ts가 존재한다
- package.json에 test, test:e2e, test:ci 스크립트가 존재한다
  </done>
</task>

<task type="auto">
  <name>Task 3: E2E 샘플 테스트 및 CI 스크립트 검증</name>
  <files>
    __tests__/e2e/smoke.spec.ts
  </files>
  <action>
1. `__tests__/e2e/smoke.spec.ts` 생성:
   - 기본 smoke test (홈페이지 접근 가능 여부)
   - test('홈페이지 로드', async ({ page }) => { await page.goto('/'); await expect(page).toHaveTitle(/리버스/); });
   - 이 테스트는 Phase 4에서 본격 E2E 작성 전 인프라 검증용

2. CI 스크립트 전체 실행 테스트:
   - npm run test:ci 실행하여 모든 테스트가 순차 실행되는지 확인
   - Jest 테스트 -> Playwright 테스트 순서

주의: smoke 테스트는 현재 앱이 실행 가능한 상태라고 가정한다. 만약 빌드 오류가 있다면 테스트가 실패할 수 있으나, 이는 인프라 설정 문제가 아니라 앱 자체 문제이므로 별도 처리.
  </action>
  <verify>
npm run test:ci

실행 결과:
1. Jest 테스트가 통과한다 (gacha.test.tsx)
2. Playwright 테스트가 실행된다 (smoke.spec.ts - 앱 상태에 따라 pass/fail)
3. 두 테스트 러너가 순차적으로 실행된다
  </verify>
  <done>
- __tests__/e2e/smoke.spec.ts가 존재한다
- npm run test:ci 실행 시 Jest와 Playwright가 순차적으로 실행된다
- 전체 인프라가 동작하여 Phase 2-4에서 테스트 추가 가능한 상태가 된다
  </done>
</task>

</tasks>

<verification>
Phase 1 완료 확인:

1. 깨진 테스트 수정 (INFRA-01):
   ```bash
   npm test -- --testPathPattern=gacha.test.tsx
   # 결과: PASS
   ```

2. Playwright 설정 (INFRA-02):
   ```bash
   npm run test:e2e -- --help
   # 결과: Playwright CLI 출력
   ```

3. Fixtures 구조 (INFRA-03):
   ```bash
   ls __tests__/fixtures/
   # 결과: index.ts, mockBanners.ts, mockCharacters.ts
   ```

4. CI 스크립트 (INFRA-04):
   ```bash
   npm run test:ci
   # 결과: Jest -> Playwright 순차 실행
   ```
</verification>

<success_criteria>
- [ ] `npm test` 실행 시 gacha.test.tsx 통과
- [ ] `npm run test:e2e` 명령이 동작 (Playwright 실행)
- [ ] `__tests__/fixtures/` 디렉토리에 mock 데이터 존재
- [ ] `npm run test:ci` 명령으로 전체 테스트 실행 가능
- [ ] lib/gacha/gachaLogic.ts에 추출된 로직 존재
</success_criteria>

<output>
After completion, create `.planning/phases/01-infrastructure/01-01-SUMMARY.md`
</output>
